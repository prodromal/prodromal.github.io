<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lunacy // terminal</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');
        
        :root { 
            --bg-light-blue: #e0f2fe;
            --gold: #d4af37;
            --silver: #94a3b8;
            --particle-white: rgba(255, 255, 255, 0.8);
            --line-yellow: rgba(250, 204, 21, 0.3);
        }

        body { 
            background: var(--bg-light-blue); 
            color: var(--silver); 
            font-family: 'Fira Code', monospace; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            margin: 0;
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-light-blue);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease-out, visibility 1s;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--silver);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Background Canvas */
        #canvas {
            position: fixed;
            top: 0; left: 0;
            z-index: 0;
            pointer-events: none;
        }

        .gold-header {
            color: var(--gold);
            font-weight: 700;
            text-transform: lowercase;
            letter-spacing: 0.15em;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        #chat-box::-webkit-scrollbar { width: 5px; }
        #chat-box::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }

        .input-line { 
            border-top: 1px solid rgba(148, 163, 184, 0.2); 
            padding: 15px 0;
            background: rgba(224, 242, 254, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10;
        }
        
        input { 
            background: transparent; 
            border: none; 
            outline: none; 
            color: #475569; /* Slightly darker silver/grey for readability on light blue */
            width: 100%; 
            font-family: inherit; 
            font-size: 1rem;
            caret-color: var(--gold);
        }

        .msg-entry { animation: fadeIn 0.3s ease-out; margin-bottom: 6px; position: relative; z-index: 11; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .system { color: var(--gold); font-style: italic; font-size: 0.8rem; }
        .username { font-weight: bold; color: var(--gold); margin-right: 8px; }
        .timestamp { color: var(--gold); opacity: 0.5; font-size: 0.7rem; margin-right: 8px; }

        footer {
            font-size: 0.75rem;
            color: var(--gold);
            opacity: 0.8;
            padding-bottom: 15px;
            text-align: center;
            text-transform: lowercase;
            z-index: 10;
        }
    </style>
</head>
<body class="p-6">

    <div id="loader">
        <div class="spinner"></div>
        <div class="gold-header">initialising_lunacy</div>
    </div>

    <canvas id="canvas"></canvas>

    <div class="flex justify-between text-[10px] mb-6 border-b border-gold/30 pb-2 relative z-10">
        <div id="net-info" class="gold-header">lunacy // standby</div>
        <div id="room-info" class="gold-header">node: null</div>
    </div>

    <div id="chat-box" class="flex-grow overflow-y-auto mb-4 relative z-10">
        <div class="msg-entry system">>> lunacy_terminal_v2.0.0</div>
        <div class="msg-entry system">>> atmosphere: celestial_blue</div>
        <div class="msg-entry system">>> protocol: golden_shard</div>
    </div>

    <div id="input-container" class="input-line flex items-center relative z-10">
        <span class="mr-3 text-gold font-bold">$</span>
        <input type="text" id="cmd-input" placeholder="transmit_to_void..." autocomplete="off" autofocus>
    </div>

    <footer class="relative z-10">
        nonepagek@gmail.com â€” &copy; gleam, 2025
    </footer>

    <script>
        // --- LUNACY CONFIG ---
        const ABLY_KEY = "vN_paw.dm-AUw:1cw-Ia3143MjEDCq0ZZrb-u1CECXJHSu6Z6JhzMd35Q"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('r') || 'celestial_hub';
        const uID = "luna_" + Math.random().toString(36).substring(7);

        document.getElementById('room-info').textContent = `node: ${roomID}`;

        // Loading Animation Logic
        window.addEventListener('load', () => {
            setTimeout(() => {
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                setTimeout(() => loader.style.visibility = 'hidden', 1000);
            }, 1500);
        });

        // --- BACKGROUND PARTICLES ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let dots = [];
        const DOT_COUNT = 60;
        const CONNECTION_DIST = 150;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            dots = [];
            for (let i = 0; i < DOT_COUNT; i++) {
                dots.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    r: Math.random() * 2 + 1
                });
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            dots.forEach((d, i) => {
                d.x += d.vx;
                d.y += d.vy;

                if (d.x < 0 || d.x > canvas.width) d.vx *= -1;
                if (d.y < 0 || d.y > canvas.height) d.vy *= -1;

                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
                ctx.fill();

                // Draw connections
                for (let j = i + 1; j < dots.length; j++) {
                    const d2 = dots[j];
                    const dist = Math.hypot(d.x - d2.x, d.y - d2.y);
                    if (dist < CONNECTION_DIST) {
                        ctx.strokeStyle = `rgba(250, 204, 21, ${0.3 * (1 - dist / CONNECTION_DIST)})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(d.x, d.y);
                        ctx.lineTo(d2.x, d2.y);
                        ctx.stroke();
                    }
                }
            });
            requestAnimationFrame(animate);
        }

        // --- ABLY LOGIC ---
        if (!ABLY_KEY) {
            log("SYSTEM", "critical: no_key_detected");
        } else {
            const ably = new Ably.Realtime(ABLY_KEY);
            const channel = ably.channels.get(roomID);

            ably.connection.on('connected', () => {
                document.getElementById('net-info').textContent = "lunacy // online";
                log("SYSTEM", `shard_link_stable: node_${roomID}`);
            });

            channel.subscribe('msg', (m) => {
                print(m.data.user, m.data.body);
            });

            const input = document.getElementById('cmd-input');
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim() !== "") {
                    channel.publish('msg', {
                        user: uID,
                        body: input.value.trim()
                    });
                    input.value = "";
                }
            });

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const box = document.getElementById('chat-box');
                    box.innerHTML = `<div class="msg-entry system">>> [NODE_HIBERNATION_ACTIVE]</div>`;
                    input.placeholder = "terminal_dormant";
                    input.disabled = true;
                }
            });
        }

        function print(user, body) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = "msg-entry flex items-baseline";
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            div.innerHTML = `
                <span class="timestamp">${time}</span> 
                <span class="username">${user}:</span> 
                <span style="word-break: break-all; color: #334155;">${body}</span>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function log(type, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = "msg-entry system";
            div.textContent = `>> [${type}] ${text}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        window.addEventListener('resize', initCanvas);
        initCanvas();
        animate();
    </script>
</body>
</html>
